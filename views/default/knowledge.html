<html>

    <head>
        <link rel="stylesheet" href="{{=URL('static','css/bootstrap.min.css')}}"/>
        <link rel="stylesheet" href="{{=URL('static','css/web2py-bootstrap3.css')}}"/>
        <link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/main.css">
        <!--<link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/bootstrap.min.css">-->
        <link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/highlight.css">
        <link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/jquery-ui.min.css">
    </head>

    <body>

        <!-- form: create/modify concepts -->
        <h2>Create a new concept</h2>
        {{=LOAD('default', 'concept.load', ajax=True)}}

        <!-- graph editor -->
        <h2>Build a relation with concepts</h2>
        <div id="graph-buttons" style="margin-bottom: 20px">
            <button id="graph-save-button" type="button" onclick="saveLaw()">Save Relation</button>
        </div>
        <div style="width: 100%; display: flex; justify-content: space-between">
            <div id="concept-palette" style="width: 160px; margin-right: 2px; background-color: whitesmoke; border: solid 1px black"></div>
            <div id="graph-canvas" style="flex-grow: 1; height: 620px; border: solid 1px black"></div>
        </div>

        <input type="hidden" id="current_framework" value="-1">
        <input type="hidden" id="current_law" value="-1">
    </body>



    {{block page_js}}
    {{include 'web2py_ajax.html'}}
    <script src="/welcome/static/GoJS-master/release/go.js"></script>
    <script src="/welcome/static/GoJS-master/assets/js/highlight.js"></script>
    <script src="/welcome/static/GoJS-master/assets/js/bootstrap.min.js"></script>
    <!--<script src="{{=URL('static', 'js/knowledge.js')}}"></script>-->
    <script>
        var $$ = go.GraphObject.make;

        var myDiagram = $$(go.Diagram, "graph-canvas",  // must name or refer to the DIV HTML element
        {
          grid: $$(go.Panel, "Grid",
                  $$(go.Shape, "LineH", { stroke: "lightgray", strokeWidth: 0.5 }),
                  $$(go.Shape, "LineH", { stroke: "gray", strokeWidth: 0.5, interval: 10 }),
                  $$(go.Shape, "LineV", { stroke: "lightgray", strokeWidth: 0.5 }),
                  $$(go.Shape, "LineV", { stroke: "gray", strokeWidth: 0.5, interval: 10 })
                ),
          allowDrop: true,  // must be true to accept drops from the Palette
          "draggingTool.dragsLink": true,
          "draggingTool.isGridSnapEnabled": true,
          "linkingTool.isUnconnectedLinkValid": true,
          "linkingTool.portGravity": 20,
          "relinkingTool.isUnconnectedLinkValid": true,
          "relinkingTool.portGravity": 20,
          "relinkingTool.fromHandleArchetype":
            $$(go.Shape, "Diamond", { segmentIndex: 0, cursor: "pointer", desiredSize: new go.Size(8, 8), fill: "tomato", stroke: "darkred" }),
          "relinkingTool.toHandleArchetype":
            $$(go.Shape, "Diamond", { segmentIndex: -1, cursor: "pointer", desiredSize: new go.Size(8, 8), fill: "darkred", stroke: "tomato" }),
          "linkReshapingTool.handleArchetype":
            $$(go.Shape, "Diamond", { desiredSize: new go.Size(7, 7), fill: "lightblue", stroke: "deepskyblue" }),
          //rotatingTool: $(TopRotatingTool),  // defined below
          //"rotatingTool.snapAngleMultiple": 15,
          //"rotatingTool.snapAngleEpsilon": 15,
          "undoManager.isEnabled": true
        });

        // when the document is modified, add a "*" to the title and enable the "Save" button
        myDiagram.addDiagramListener("Modified", function(e) {
          var button = document.getElementById("graph-save-button");
          if (button) button.disabled = !myDiagram.isModified;
          var idx = document.title.indexOf("*");
          if (myDiagram.isModified) {
            if (idx < 0) document.title += "*";
          } else {
            if (idx >= 0) document.title = document.title.substr(0, idx);
          }
        });

        myDiagram.nodeTemplate = $$(go.Node, "Spot",
            { locationSpot: go.Spot.Center },
            new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
            new go.Binding("angle").makeTwoWay(),
            // the main object is a Panel that surrounds a TextBlock with a Shape
            $$(go.Panel, "Auto",
              { name: "PANEL" },
              new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),
              $$(go.Shape, "Rectangle",  // default figure
                {
                  cursor: "pointer",
                  fill: "white",  // default color
                  strokeWidth: 2
                },
                new go.Binding("figure"),
                new go.Binding("fill")),
              $$(go.TextBlock,
                {
                  font: "bold 11pt Helvetica, Arial, sans-serif",
                  margin: 8,
                  maxSize: new go.Size(160, NaN),
                  wrap: go.TextBlock.WrapFit,
                  editable: true
                },
                new go.Binding("text").makeTwoWay())
            ),
            //port on top for head/reference, port on bottom for properties/referrers
            makePort("T", go.Spot.Top, true, true, 1, 1),
            makePort("B", go.Spot.Bottom, true, true),
            { // handle mouse enter/leave events to show/hide the ports
              mouseEnter: function(e, node) { showSmallPorts(node, true); },
              mouseLeave: function(e, node) { showSmallPorts(node, false); }
            }
        );

        clearDiagram();

        //concepts required by any framework
        var CORE_CONCEPTS = $$(go.GraphLinksModel, {
            nodeDataArray: [
                    {{
                        concepts = db(db.concept.framework == None).select()
                        for concept in concepts:
                    }}
                { concept: {{=concept.id}}, text: "{{=concept.name}}", figure: "RoundedRectangle", fill: "#88AD5F" },
                    {{
                        pass
                    }}
            ],
            linkDataArray: []
        });

        // initialize the Palette that is on the left side of the page
        var myPalette = $$(go.Palette, "concept-palette",  // must name or refer to the DIV HTML element
        {
            maxSelectionCount: 1,
            nodeTemplateMap: myDiagram.nodeTemplateMap,  // share the templates used by myDiagram
            model: CORE_CONCEPTS,
        });


        function makePort(name, spot, output, input, fromMax, toMax) {
            // the port is basically just a small transparent square
            var options =
            {
                fill: null,  // not seen, by default; set to a translucent gray by showSmallPorts, defined below
                stroke: null,
                desiredSize: new go.Size(7, 7),
                alignment: spot,  // align the port on the main Shape
                alignmentFocus: spot,  // just inside the Shape
                portId: name,  // declare this object to be a "port"
                fromSpot: spot, toSpot: spot,  // declare where links may connect at this port
                fromLinkable: output, toLinkable: input,  // declare whether the user may draw links to/from here
                cursor: "pointer"  // show a different cursor to indicate potential link point
            };
            if(fromMax !== undefined) options.fromMaxLinks = fromMax;
            if(toMax !== undefined) options.toMaxLinks = toMax;
            return $$(go.Shape, "Circle", options);
        }

        function showSmallPorts(node, show) {
          node.ports.each(function(port) {
            if (port.portId !== "") {  // don't change the default port, which is the big shape
              port.fill = show ? "rgba(0,0,0,.3)" : null;
            }
          });
        }

        function clearDiagram() {
            myDiagram.model = $$(go.GraphLinksModel,
            {
               linkFromPortIdProperty: 'fromPort',
               linkToPortIdProperty: 'toPort',
            });
        }

        function useFramework(id) { useFrameworkOrLaw('framework', id); }
        function useLaw(id) { useFrameworkOrLaw('law', id); }

        function useFrameworkOrLaw(type, id) {
            var currentFramework = parseInt($('#current_framework').val()),
                currentLaw = parseInt($('#current_law').val());
            $.ajax({
                url: "{{=URL('default', 'useFrameworkOrLaw', extension='json')}}",
                type: 'get',
                dataType: 'json',
                data: {
                    type: type,
                    id: id,
                    currentFramework: currentFramework,
                    currentLaw: currentLaw,
                },
                success: function(data) {
                    //if we received a new framework to use, clear the existing one from the palette
                    //and populate it with the new concepts
                    if(data.frameworks && data.frameworks.length > 0) {
                        myPalette.model = CORE_CONCEPTS;
                        data.frameworks.forEach(function(framework) {
                            framework.concepts.forEach(function(concept) {
                                myPalette.model.addNodeData({
                                    concept: concept.id, text: concept.name, figure: "RoundedRectangle", fill: "#88AD5F"
                                })
                            });
                        });
                        if(data.frameworks[0].id) $('#current_framework').val(data.frameworks[0].id);
                    }
                    //if we received a new law to use, clear the existing one from the graph
                    //and populate it with the new nodes
                    if(data.law && data.law.nodes) {
                        myDiagram.removeParts(myDiagram.nodes);
                        data.law.nodes.forEach(function(node) {
                        });
                        if(data.law.id) $('#current_law').val(data.law.id);
                    }
                },
                error: function() {
                }
            });
        }

        function saveLaw() {
            var id = $('#current_law').val();
            if(isNaN(id)) return;

            var nodes = [];
            myDiagram.nodes.each(function(node) {
                var data = {
                    'id': node.data['key'], 'law': id, 'concept': node.data['concept'],
                    'head': null, 'reference': null, 'predicate': null
                };
                var head = node.findNodesInto('T'),
                    reference = node.findNodesOutOf('T');
                if(head.count > 0) data['head'] = head.first().data['key'];
                if(reference.count > 0) data['reference'] = reference.first().data['key'];
                nodes.push(data);
            });

            $.ajax({
                url: "{{=URL('default', 'saveLaw', extension='json')}}",
                type: 'post',
                dataType: 'json',
                data: JSON.stringify({id: id, nodes: nodes}),
                success: function(data) {
                    $('#law-save-msg').val('Relation saved').show(3000);
                },
                error: function() {
                }
            });
        }

        /* EVALUATION */
        var NEXT_NODE_ID = 0, NEW_NODES = [];

        function evaluateRelation() {
            var relationNodes = getIndex('relation_node'), nodes = getIndex('node'), predicates = getIndex('predicate');
            myDiagram.nodes.each(function(node) {
               //find any deep predicate nodes in included frameworks
               //that have the same concept as this node
               var key = node.data['key'];
               if(!relationNodes.hasOwnProperty(key)) return;
               var nodeId = relationNodes[key], relationNode = nodes[id], concept = relationNode['concept'];
               if(!predicates.hasOwnProperty(concept)) return;
               predicates[concept].each(function(predicateId) {
                   var idMap = {};
                   if(checkPredicate(nodeId, predicateId, idMap)) {
                       appendLaw(nodeId, predicateId, idMap);
                   }
               });
            });
        }

        //see if the relation matches the predicate by recursively tracing the law up to its wildcards
        function checkPredicate(nodeId, predicateId, idMap) {

            var nodes = getIndex('node'), concepts = getIndex('concept');
            var node = nodes[nodeId], predicate = nodes[predicateId];

            //make sure this node's concept matches the predicate's concept
            var match = node['concept'] == predicate['concept'] || concepts[predicate['concept']]['name'] == 'Anything';
            if(!match) return false;
            idMap[predicateId] = nodeId;

            //check recursively on this node's head and reference
            var links = ['head', 'reference'];
            for(var i = 0; i < 2; i++) {
                var link = links[i], nodeLink = node[link], predicateLink = predicate[link];
                if(!predicateLink) continue;
                else if(!nodeLink || !checkPredicate(nodeLink, predicateLink)) return false;
            }
            return true;
        }

        //given a correspondence between nodes in the relation and predicate, fill in the rest of the law
        function appendLaw(nodeId, predicateId, idMap) {

            var nodes = getIndex('node'), lawNodes = getIndex('law_node');
            var node = nodes[nodeId], predicate = nodes[predicateId], law = predicate['law'], lawNode = lawNodes[law];

            return appendLawHelper(lawNode, idMap);
        }

        function appendLawHelper(nodeId, idMap) {

            var nodes = getIndex('node');
            var node = nodes[nodeId], head = node['head'], reference = node['reference'], newHead, newReference;

            if(!idMap.hasOwnProperty(head)) newHead = appendLawHelper(head, idMap);
            else newHead = idMap[head];
            if(!idMap.hasOwnProperty(reference)) newReference = appendLawHelper(reference, idMap);
            else newReference = idMap[reference];

            var newNode = $.extend({}, node), newId = getNextNodeID();
            newNode['id'] = newId;
            newNode['law'] = getCurrentLaw();
            newNode['head'] = newHead;
            newNode['reference'] = newReference;
            NEW_NODES.push(newNode);
            idMap[nodeId] = newId;
            return newId;
        }

        function getNextNodeID() {
            return NEXT_NODE_ID++;
        }

        function getCurrentLaw() {
            return $('#current_law').val();
        }
    </script>
    {{end page_js}}



    {{block page_css}}
    <style>
        html {
            height: 100%;
        }
        body {
            min-height: 100%;
            margin: 20px;
        }

        .concept {
            border: 3px solid red;
            border-radius: 4px;
            padding: 6px;
            font-size: 14px;
            color: black;
        }

        #editor-wrapper {
            display: table;
            width: 100%;
            height: 100%;
        }
        #editor-container {
            display: table-row;
            width: 100%;
            height: 100%;
        }
        #concept-container, #graph-container {
            display: table-cell;
        }
        #concept-container {
            width: 10%;
            height: 100%;
            border: 3px solid blue;
        }
        #graph-container {
            width: auto;
            height: 100%;
            border: 3px solid green;
        }

        #graph-save-button {
            border: 2px solid black;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            background-color: #aaaaff;
            color: black;
        }
    </style>
    {{end page_css}}

</html>