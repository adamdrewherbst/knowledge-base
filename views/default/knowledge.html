<html>

    <head>
        <link rel="stylesheet" href="{{=URL('static','css/bootstrap.min.css')}}"/>
        <link rel="stylesheet" href="{{=URL('static','css/web2py-bootstrap3.css')}}"/>
        <link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/main.css">
        <!--<link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/bootstrap.min.css">-->
        <link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/highlight.css">
        <link rel="stylesheet" href="/welcome/static/GoJS-master/assets/css/jquery-ui.min.css">

        <script type="text/javascript" async
          src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=MML_CHTML">
        </script>
    </head>

    <body>

        <!-- controls -->
        <div id="controls">
            <div class="entry-wrapper" table="framework">
                <button class="entry-set-button" type="button" class="btn btn-primary">Select Framework</button>
                <div class="entry-info">
                    <div class="entry-msg">Using Framework <span class="entry-name">NONE</span></div>
                    <button class="entry-edit-button" type="button" class="btn btn-primary">Edit</button>
                </div>
            </div>
            <div class="entry-wrapper" table="law">
                <button class="entry-set-button" type="button" class="btn btn-primary">Select Law</button>
                <div class="entry-info">
                    <div class="entry-msg">Using Law <span class="entry-name">NONE</span></div>
                    <button class="entry-edit-button" type="button" class="btn btn-primary">Edit</button>
                </div>
            </div>
        </div>

        <!-- graph editor -->
        <h2>Build a relation with concepts</h2>
        <div id="graph-buttons" style="margin-bottom: 20px">
            <div id="graph-controls">
                <div id="palette-controls">
                    <button id="concept-create-button" type="button" class="btn btn-primary">New Concept</button>
                    <select id="palette-concept-filter" class="framework-filter">
                        <option value="-1">-- Filter --</option>
                    </select>
                </div>
                <div id="predicate-controls">
                    <select id="set-predicate">
                        <option value="-1">Select Predicate</option>
                        <option value="new">New Predicate</option>
                    </select>
                    <button id="remove-predicate" type="button" class="btn btn-primary">Remove Predicate</button>
                    <label id="predicate-help">Right-click a node to add/remove it from this predicate</label>
                </div>
                <div id="relation-controls">
                    <button id="save-relation" type="button" class="btn btn-primary">Save Relation</button>
                    <button id="evaluate-relation" type="button" class="btn btn-primary">Evaluate</button>
                    <label id="evaluate-msg"></label>
                </div>
            </div>
        </div>
        <div style="width: 100%; display: flex; justify-content: space-between">
            <div id="concept-palette" style="width: 160px; margin-right: 2px; background-color: whitesmoke; border: solid 1px black"></div>
            <div id="graph-canvas" style="flex-grow: 1; height: 620px; border: solid 1px black"></div>
            <div id="node-info" style="display: inline-block; vertical-align: top;">
                <h3 id="node-title"></h3>
                <p id="node-description"></p>
            </div>
        </div>

        {{ =LOAD('default', 'entry.load', ajax=False, vars={'table': 'framework'}) }}
        {{ =LOAD('default', 'entry.load', ajax=False, vars={'table': 'law'}) }}
        {{ =LOAD('default', 'entry.load', ajax=False, vars={'table': 'concept'}) }}

        <div id="symbolization">
            <div id="sybolization-controls">
                <button id="reset-relation" type="button" class="btn btn-primary">Reset</button>
                <button id="resolve-data" type="button" class="btn btn-primary">Resolve</button>
                <button id="symbolize-relation" type="button" class="btn btn-primary">Symbolize</button>
                <button id="suggest-step" type="button" class="btn btn-primary">Suggest</button>
            </div>
            <div id="symbolization-wrapper">
            </div>
            <div id="suggestion-wrapper">
            </div>
        </div>

        <div id="visualization">
            <div id="visualization-controls">
                <button id="visualize-relation" type="button" class="btn btn-primary">Visualize</button>
            </div>
            <canvas id="visualization-canvas">
            </canvas>
        </div>

    </body>



    {{block page_css}}
    <style>
        html {
            height: 100%;
        }
        body {
            min-height: 100%;
            margin: 20px;
        }

        .entry-wrapper {
            padding: 10px 0;
        }
        .entry-set-button {
            display: inline-block;
        }
        .entry-info {
            display: inline-block;
        }
        .entry-msg {
            display: inline-block;
            margin-right: 20px;
        }
        .entry-edit-button {
            display: inline-block;
        }


        .entry-modal {
            /*overflow: scroll;*/
        }
        .entry-modal .modal-dialog {
            width: 70%;
        }
        .entry-modal .nav-tabs {
            border-width: 2px;
        }
        .entry-modal .nav-tabs > li {
            font-size: 16px;
        }
        .entry-modal .nav-tabs > li > a {
            border-width: 2px;
        }
        .entry-modal .tab-content {
            padding: 10px;
        }
        .entry-modal .tab-pane > * {
            display: block;
            margin-bottom: 5px;
        }
        .entry-modal input, .entry-modal select, .entry-modal textarea {
            border-radius: 5px;
            font-size: 18px;
            background-color: #eff;
            color: #000;
        }
        .entry-modal .form-group label {
            display: block;
        }
        .entry-modal input {
            width: 50%;
        }
        .entry-modal textarea {
            width: 100%;
        }
        .entry-modal .result-display {
            padding: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            overflow-x: hidden;
        }
        .entry-modal .result-display.selected {
            background-color: #ddf;
            border-radius: 10px;
        }
        .entry-modal .result-display > span {
            display: inline-block;
            white-space: nowrap;
            overflow-x: hidden;
        }
        .entry-modal .result-display > .result-name {
            width: 40%;
        }
        .entry-modal .result-display > .result-description {
        }
        .entry-modal .tab-footer {
            text-align: right;
        }


        .multiple-template {
            display: none;
        }



        /*.concept {
            border: 3px solid red;
            border-radius: 4px;
            padding: 6px;
            font-size: 14px;
            color: black;
        }*/

        #editor-wrapper {
            display: table;
            width: 100%;
            height: 100%;
        }
        #editor-container {
            display: table-row;
            width: 100%;
            height: 100%;
        }
        #concept-container, #graph-container {
            display: table-cell;
        }
        #concept-container {
            width: 10%;
            height: 100%;
            border: 3px solid blue;
        }
        #graph-container {
            width: auto;
            height: 100%;
            border: 3px solid green;
        }

        #graph-controls {
        }
        #predicate-controls, #relation-controls {
            margin-bottom: 20px;
        }
        #graph-controls button, #graph-controls select {
            padding: 5px 10px;
            border: 2px solid black;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            background-color: #aaaaff;
            color: black;
        }
        #predicate-controls {
            float: left;
        }
        #predicate-controls button {
        }
        #remove-predicate, #predicate-help {
            display: none;
        }
        #relation-controls {
            float: right;
        }
        #relation-controls button {
        }

        #node-info {
            background-color: #8ff;
            color: #604;
            font-weight: bold;
            padding: 0 20px;
        }


        #symbolization {
        }
        #symbolization-controls {
            margin: 20px 0;
        }
        #symbolization-wrapper {
            width: 100%;
            text-align: center;
        }

        #visualization {
        }
        #visualization-controls {
            margin: 20px 0;
        }
        #visualization-canvas {
            border: 3px solid green;
        }

        #suggestion-wrapper {
            display: table;
            width: 100%;
        }
        .suggestion {
            display: table-row;
        }
        .suggestion-name {
            font-size: 28px;
            font-weight: bold;
            float: left;
        }
        .suggestion-symbol {
            margin-left: 5%;
            font-size: 18px;
            color: #606;
        }
        .suggestion-accept {
            color: white;
            background-color: #080;
            margin-left: 5%;
        }

        hr {
            display: block;
            height: 1px;
            border: 0;
            border-top: 1px solid #ccc;
            margin: 1em 0;
            padding: 0;
        }
    </style>
    {{end page_css}}




    {{block page_js}}
    {{include 'web2py_ajax.html'}}
    <script type="text/javascript" src="/welcome/static/GoJS-master/release/go.js"></script>
    <script type="text/javascript" src="/welcome/static/GoJS-master/assets/js/highlight.js"></script>
    <script type="text/javascript" src="/welcome/static/GoJS-master/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript">

        var $$ = go.GraphObject.make;

        /*********   RELATION   *****************

        A wrapper class for all functionality on this page

        *****************************************/

        function Relation() {

            this.paletteFramework = null;
            this.paletteFrameworks = [];

            this.frameworks = {};
            this.frameworks[-1] = new Framework();
            this.frameworks[-1].id = -1;
            this.frameworks[-1].relation = this;
            this.framework = this.frameworks[-1];

            this.concepts = {};

            this.laws = {};
            this.laws[-1] = new Law();
            this.laws[-1].id = -1;
            this.laws[-1].relation = this;
            this.law = this.laws[-1];

            this.nodes = {};
            this.nodes[0] = new Node();
            this.nodes[0].id = 0;
            this.nodes[0].relation = this;

            this.predicates = {};
            this.predicateNodes = {};

            this.nodesToCheck = [];
            this.newNodes = [];
            this.evaluated = {};

            this.tempIdMap = null;
            this.nodeMap = {};
            this.map = {};
            this.nextMapId = 0;
            this.nextNodeId = 0;

            this.nodeTemplates = {
                'default': {
                    shape: "RoundedRectangle",
                    fill: "#88AD5F"
                },
                'predicate': {
                    shape: "Rectangle",
                    fill: "yellow"
                },
                'appended': {
                    shape: 'RoundedRectangle',
                    fill: '#FF66AA'
                },
                'tentative': {
                    shape: 'RoundedRectangle',
                    fill: '#8888FF'
                }
            };

            this.concepts = {};
            this.wildcardConcept = 2;

            this.nextId = {'concept': -1, 'node': -1, 'law': -1, 'framework': -1};

            this.predicateSets = [];
            this.currentPredicate = -1;

            this.options = {
                evaluate: {}
            };
            this.stats = {
                evaluate: {}
            };
        }

        Relation.prototype.loadFrameworkURL = "{{=URL('default', 'loadFramework', extension='json')}}";
        Relation.prototype.saveEntryURL = "{{=URL('default', 'saveEntry', extension='json')}}";
        Relation.prototype.saveRelationURL = "{{=URL('default', 'saveRelation', extension='json')}}";
    </script>

    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/databaseWrappers.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/diagram.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/interface.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/nodeData.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/evaluate.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/represent.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/suggest.js')}}"></script>

    <script type="text/javascript">
        var relation;
        $(document).ready(function() {
            relation = new Relation();
            let self = relation;

            self.initDiagram();
            self.useFramework(7, 9);

            let $hideButton = null;
            $('.entry-modal button[data-dismiss=modal]').click(function(e) {
                $hideButton = $(this);
            });
            $('.entry-modal').on('show.bs.modal', function(e) {
                $hideButton = null;
            });
            $('.entry-modal').on('hide.bs.modal', function(e) {

                let $this = $(this), $button = $hideButton || $(document.activeElement), callback = $this.data('callback');
                let prefix = $this.attr('id'), prefixArr = prefix.split('-'), table = prefixArr[0], type = prefixArr[1];
                console.log('modal ' + $this.attr('id') + ' hidden');

                if($button.hasClass('modal-cancel')) {
                    return;

                } else if($button.hasClass('modal-select')) {
                    let id = $('#' + table + '-selected-id').val();
                    if(!id) return;
                    if(callback) callback.call(self, id);

                } else if($button.hasClass('modal-save')) {
                    let $form = $this.find('form.entry-form'), arr = $form.serializeArray(), obj = {};
                    for(let i = 0; i < arr.length; i++) obj[arr[i]['name']] = arr[i]['value'];

                    //convert any multiple fields to proper format
                    $form.find('.multiple-template').each(function() {
                        let $this = $(this), $fields = $this.find('[name]');
                        $fields.each(function() {
                            let name = $(this).attr('name');
                            obj[name] = {};
                            for(let key in obj) if(key.startsWith(name + '_')) {
                                obj[name][obj[key]] = true;
                                delete obj[key];
                            }
                        });
                    });

                    if(table == 'framework') {
                        for(let dep in obj.dependencies) {
                            let framework = self.findEntry('framework', dep);
                            //when saving a framework, flag dependency frameworks that need to be loaded
                            //so the server can send them
                            obj.dependencies[dep] = framework && !framework.loaded;
                        }
                    } else if(table == 'concept') {
                        obj.law = null;
                        obj.commands = (obj.commands || '').replace(/\n/g, '<DELIM>');
                    }

                    console.log('saving entry');
                    console.info(obj);
                    $.ajax({
                        url: Relation.prototype.saveEntryURL,
                        type: 'post',
                        dataType: 'json',
                        data: JSON.stringify(obj),
                        success: function(data) {
                            if(data.hasOwnProperty('id') && !isNaN(data.id)) {
                                self.storeEntries(data);
                                if(callback) callback.call(self, data.id);
                            }
                        }
                    });
                }
            });

            let $filters = $('.framework-filter');
            $filters.change(function(e) {
                let $this = $(this), framework = $this.val(), $modal = $(this).parents('.modal');
                if($modal.length > 0) {
                    $modal.find('.framework-filter').val(framework);
                    self.showSearchResults(table, '');
                } else if($this.attr('id') == 'palette-concept-filter') {
                    self.filterPalette(framework);
                }
            });

            $('.entry-wrapper').each(function() {
                let $this = $(this), table = $this.attr('table');
                $this.find('.entry-set-button').click(function(e) {
                    self.selectEntry(table, function(id) {
                        if(table == 'framework') self.useFramework(id);
                        else if(table == 'law') self.useLaw(id);
                        let entry = self.findEntry(table, id);
                        $this.find('.entry-name').text(entry.name || 'None');
                        $this.find('.entry-info').show();
                    });
                });
                $this.find('.entry-edit-button').click(function(e) {
                    let id = table == 'framework' ? self.framework.id : table == 'law' ? self.law.id : null;
                    if(!id) return;
                    self.editEntry(table, id);
                });
            });

            $('#concept-create-button').click(function(e) {
                self.newEntry('concept');
            });

            $('.search-field').on('keydown change', function(e) {
                let $this = $(this), text = $this.val().toLowerCase(), table = $this.attr('id').split('-')[0];
                self.showSearchResults(table, text);
            });

            $('.multiple-wrapper').each(function() {
                let $this = $(this);
                self.addMultipleField($this);
                $this.find('.multiple-add').click(function(e) {
                    self.addMultipleField($this);
                });
            });


            $('#set-predicate').change(function(e) {
                relation.setPredicate($(this).val());
            });
            $('#remove-predicate').click(function(e) {
                relation.removePredicate();
            });

            $('#save-relation').click(function(e) {
                relation.save();
            });
            $('#evaluate-relation').click(function(e) {
                relation.evaluate({ reset: true });
            });
            $('#reset-relation').click(function(e) {
                relation.reset();
            });
            $('#resolve-data').click(function(e) {
                relation.law.resolveData();
            });
            $('#visualize-relation').click(function(e) {
                relation.visualize();
            });
            $('#symbolize-relation').click(function(e) {
                relation.symbolize();
            });
            $('#suggest-step').click(function(e) {
                relation.suggest();
            });
        });
    </script>
    {{end page_js}}

</html>