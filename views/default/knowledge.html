{{#
#
#   This is the main file of the website.  It specifies the structure of the page in the HTML section,
#   the layout and styling in the CSS section (block_page_css), and the user interaction in the
#   JavaScript section (block_page_js).
#
#   The site uses a few plugins:
#
#       Bootstrap: lets you create common pieces of a website with little code.  Here, for example, we use
#           its Modal functionality to create modals (pop-up dialogs with arbitrary content inside) that let
#           the user select, create, and edit records from the database.
#
#           https://getbootstrap.com/
#
#               Our installation of Bootstrap is a little sensitive because both the web2py framework and GoJS (below)
#               already come with Bootstrap for their own purposes, so we need to include Bootstrap files that are
#               compatible with both of these as well as our modals etc.  Right now you will see in the header below
#               that we are using both css/bootstrap.min.css, which I downloaded directly from getbootstrap.com,
#               and css/web2py-bootstrap3.js which came with web2py.  Whereas the only JS file is
#               GoJS-master/assets/js/bootstrap.min.js, the one from GoJS.  That seems to be stable, but could
#               conceivably have to be tweaked.
#
#       GoJS: we use this to display the interactive diagram that represents the problem as a graph of
#           connected concepts.
#           v 1.8.17, installed 4/20/2018
#           Browse the docs for the installed version at:
#               https://adamdrewherbst.pythonanywhere.com/welcome/static/GoJS-master/index.html
#           Or if you're planning to upgrade to the latest version:
#               https://gojs.net/latest/index.html
#
#       MathJax: we use this to render the symbolic representation of the relation, in mathematical notation.
#           The latest version is included via the script tag in the header below.  We render symbols in MathML
#              (http://math-it.org/Publikationen/MathML.html)
#           and MathJax automatically on-the-fly makes sure they look good in the browser.
#
#           https://www.mathjax.org
#
#       jQuery: a very common JavaScript plugin which is pre-installed with web2py.
#       jQuery makes common operations on elements in the web page much simpler in code, such as:
#           selecting, adding, and editing elements on the page
#           sending requests to the server - in this case, to load and save frameworks, concepts, and laws
#
#           https://api.jquery.com/
#
#       Wherever you see $(...) in the JavaScript, that is the jQuery selector function, which selects all elements
#       based on the given criteria and turns them into a jQuery object so you can call jQuery functions on them,
#       such as .remove(), .append(), etc. to change how they are displayed, add/remove elements, animate them,
#       trigger a function when a user clicks them, etc.  Also you will see $.ajax wherever we make a call to the server.
#
#}}


<html>

    {{#
    #   Here we include CSS files which determine how elements are visually styled (margins, padding, colors, fonts, etc)
    #}}
    <head>
        <link rel="stylesheet" href="{{=URL('static','css/bootstrap.min.css')}}"/>
        <link rel="stylesheet" href="{{=URL('static','css/web2py-bootstrap3.css')}}"/>
        <link rel="stylesheet" href="{{=URL('static','GoJS-master/assets/css/main.css')}}">
        <link rel="stylesheet" href="{{=URL('static','GoJS-master/assets/css/highlight.css')}}">
        <link rel="stylesheet" href="{{=URL('static','GoJS-master/assets/css/jquery-ui.min.css')}}">
        <link rel="stylesheet" href="{{=URL('static','css/main.css')}}">

        {{#  As well as MathJax to auto-prettify mathematical symbols }}

        <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=MML_CHTML"></script>
    </head>

    <body>

        {{#
        # Here is the palette & diagram where the user can drag concepts from the palette onto the diagram and arrange them into
        # a connected relation represented the problem at hand, or a general law.  This functionality is provided by the GoJS
        # plugin and used mainly in diagram.js
        # }}

        <h2>Build a relation with concepts</h2>
        <div id="graph-buttons" style="margin-bottom: 20px">
            <div id="graph-controls">
                <div id="palette-controls">
                    <button id="concept-create-button" type="button" class="btn btn-primary">New Concept</button>
                    <select id="palette-concept-filter" class="framework-filter">
                        <option value="-1">-- Filter --</option>
                    </select>
                </div>
                <div id="predicate-controls">
                    <select id="set-predicate">
                        <option value="-1">Select Predicate</option>
                        <option value="new">New Predicate</option>
                    </select>
                    <button id="remove-predicate" type="button" class="btn btn-primary">Remove Predicate</button>
                    <label id="predicate-help">Right-click a node to add/remove it from this predicate</label>
                </div>
                <div id="relation-controls">
                    <button id="save-relation" type="button" class="btn btn-primary">Save All Changes</button>
                    <!--<button id="evaluate-relation" type="button" class="btn btn-primary">Evaluate</button>-->
                    <label id="evaluate-msg"></label>
                </div>
            </div>
        </div>
        <div style="width: 100%; display: flex; justify-content: space-between">
            <div id="concept-palette" style="width: 160px; margin-right: 2px; background-color: whitesmoke; border: solid 1px black"></div>
            <div id="graph-canvas" style="flex-grow: 1; height: 620px; border: solid 1px black"></div>
            <div id="node-info" style="display: inline-block; vertical-align: top;">
                <h3 id="node-title"></h3>
                <p id="node-description"></p>
            </div>
        </div>

        <div id="symbolization">
            <div id="sybolization-controls">
                <button id="reset-relation" type="button" class="btn btn-primary">Reset</button>
                <button id="resolve-data" type="button" class="btn btn-primary">Resolve</button>
                <button id="symbolize-relation" type="button" class="btn btn-primary">Symbolize</button>
                <button id="suggest-step" type="button" class="btn btn-primary">Suggest</button>
            </div>
            <div id="symbolization-wrapper">
            </div>
            <div id="suggestion-wrapper">
            </div>
        </div>

        {{# And here we display the entire relation as a picture when you click 'Visualize' }}

        <div id="visualization">
            <div id="visualization-controls">
                <button id="visualize-relation" type="button" class="btn btn-primary">Visualize</button>
            </div>
            <canvas id="visualization-canvas">
            </canvas>
        </div>

    </body>


    {{block page_js}}
    {{include 'web2py_ajax.html'}}

    <script type="text/javascript" src="https://unpkg.com/gojs/release/go.js"></script>
    <!--<script type="text/javascript" src="/welcome/static/GoJS-master/release/go.js"></script>
    <script type="text/javascript" src="/welcome/static/GoJS-master/assets/js/highlight.js"></script>
    <script type="text/javascript" src="/welcome/static/GoJS-master/assets/js/bootstrap.min.js"></script>-->

    <script type="text/javascript">

        var $$ = go.GraphObject.make;

        /*********   PAGE   *****************

        A wrapper class for all functionality on this page

        *****************************************/

        var Page = {};

        Page.nodeTemplates = {
            'default': {
                shape: "RoundedRectangle",
                fill: "#88AD5F"
            },
            'predicate': {
                shape: "Rectangle",
                fill: "yellow"
            },
            'appended': {
                shape: 'RoundedRectangle',
                fill: '#FF66AA'
            },
            'tentative': {
                shape: 'RoundedRectangle',
                fill: '#8888FF'
            }
        };

        Page.currentConcept = null;
        Page.currentPredicate = -1;

        // options that control how evaluation is performed, and stats to keep track of how many nodes have been checked, etc.

        Page.options = {
            evaluate: {}
        };
        Page.stats = {
            evaluate: {}
        };

        // the URLs we will need in other JavaScript files when making server calls

        Page.loadConceptURL = "{{=URL('default', 'loadRecord', extension='json')}}";
        Page.saveConceptURL = "{{=URL('default', 'saveRecord', extension='json')}}";

    </script>


    {{# The rest of the JavaScript, which provides most of the page functionality }}

    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/databaseWrappers.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/diagram.js')}}"></script>
<!--    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/interface.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/nodeData.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/evaluate.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/represent.js')}}"></script>
    <script type="text/javascript" src="{{=URL('static', 'js/knowledge/suggest.js')}}"></script>-->


    {{#
    # Here we perform initial JS functions once the page has been loaded, such as pulling the list of frameworks from
    # the server, and attaching handlers to various elements on the page so they perform their desired action upon user input
    #}}

    <script type="text/javascript">

        $(document).ready(function() {

            Concept.setFields();
            Concept.setBindings();

            Page.tables = {
                concept: new Table(Concept),
            }
            Concept.table = Page.tables.concept;

            Page.initDiagram();

            Page.loadConcept(1, function() {
                Page.getConcept(1).load();
            });

        });
    </script>
    {{end page_js}}

</html>